name: E2E Run
description: 'Run a E2E spec'
inputs:
  spec:
    description: 'The spec to run'
    required: true
  os:
    description: 'The OS on which the action run'
    required: true
  node:
    description: 'The Node version on which the action run'
    required: true
  cliConfigJson:
    description: 'The CLI config generated by the login'
    required: true
  npmRegistry:
    description: 'The NPM Registry to use'
    required: false
    default: 'https://registry.npmjs.org/'
  jestFlags:
    description: 'Flags for Jest'
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Setup runner
      shell: bash
      if: ${{inputs.os == 'ubuntu-20.04'}}
      # Ensure we can use as many file watcher as we want. see https://github.com/facebook/create-react-app/blob/master/docusaurus/docs/troubleshooting.md#npm-start-fail-due-to-watch-error
      run: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p
    - name: Setup runner
      shell: bash
      if: ${{inputs.os == 'windows-latest'}}
      run: |
        git config --global core.autocrlf false
        git config --global core.eol lf
        npm i -g npm@10.8.2
    - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
      with:
        cache: 'npm'
        node-version-file: '.nvmrc'
    - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        cache: 'pip'
        python-version: '3.10'
    - name: Install Mitmproxy through pip
      shell: bash
      run: pip install -r packages/cli-e2e/mitmproxy/requirements.txt
    - name: Decrypt config
      shell: bash
      working-directory: packages/cli-e2e
      run: echo ${{inputs.cliConfigJson}} | base64 --decode | gpg --quiet --batch --yes --decrypt --passphrase="${{ env.E2E_TOKEN_PASSPHRASE }}" --output decrypted
    - run: npm ci
      shell: bash
    - name: End-to-end Setup
      shell: bash
      if: ${{inputs.os == 'ubuntu-20.04'}}
      run: bash packages/cli-e2e/entrypoints/ci.sh
    - name: End-to-end Setup
      shell: powershell
      if: ${{inputs.os == 'windows-latest'}}
      run: packages/cli-e2e/entrypoints/ci.ps1
    - name: Tests
      shell: bash
      if: ${{inputs.os == 'windows-latest'}}
      working-directory: packages/cli-e2e
      run: npm run jest:ci -- ${{inputs.spec}} ${{inputs.flag}}
      env:
        npm_config_registry: ${{inputs.npmRegistry}}
    - name: Tests
      shell: bash
      if: ${{inputs.os == 'ubuntu-20.04'}}
      env:
        DISPLAY: ':1'
        npm_config_registry: ${{inputs.npmRegistry}}
      working-directory: packages/cli-e2e
      run: npm run jest:ci -- ${{inputs.spec}} ${{inputs.flag}}
    - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
      if: cancelled() || failure() || success()
      with:
        name: ${{inputs.os}}-${{inputs.node}}-${{inputs.spec}}-test-artifacts
        path: ./packages/cli-e2e/artifacts
