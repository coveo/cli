name: E2E Clean
description: Remove resources created by the E2E
inputs:
  cliConfigJson:
    description: 'The CLI config generated by the login'
    required: true
runs:
  using: composite
  steps:
    - run: echo "::group::Setup Node"
      shell: bash
    - uses: actions/setup-node@2fddd8803e2f5c9604345a0b591c3020ee971a93 # tag=v3
      with:
        node-version: 16
        cache: 'npm'
    - run: echo "::endgroup::"
      shell: bash
    - name: Install locked NPM version.
      shell: bash
      # TODO: CDX-1010 | Remove in CDX-1010.
      run: |
        echo "::group::Setup NPM"
        npm i -g npm@8.10.0
        echo "::endgroup::"
    - run: |
        echo "::group::Install NPM dependencies"
        npm ci
        echo "::endgroup::"
      shell: bash
    - name: Decrypt config
      shell: bash
      run: |
        echo "::group::Decrypt Config"
        echo ${{inputs.cliConfigJson}} | base64 --decode | gpg --quiet --batch --yes --decrypt --passphrase="${{ env.E2E_TOKEN_PASSPHRASE }}" --output decrypted
        echo "::endgroup::"
    - name: Delete test org
      shell: bash
      env:
        DISPLAY: ':1'
      if: always()
      run: |
        echo "::group::Delete test org"
        Xvfb :1 -screen 0 1024x768x16 & sleep 1
        xdg-settings set default-web-browser google-chrome.desktop
        node -r ts-node/register/transpile-only packages/cli-e2e/cleaning.ts
        node ./scripts/cleaning/delete-orgs.js
        echo "::endgroup::"
    - name: Delete test API key
      shell: bash
      if: always()
      run: |
        echo "::group::Delete test org"
        node ./scripts/cleaning/delete-api-keys.js
        echo "::endgroup::"
