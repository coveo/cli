name: Build
on:
  push:
    branches:
      - master
  pull_request:

jobs:
  run-script:
    runs-on: ubuntu-latest
    env:
      PLATFORM_USER_NAME: ${{ secrets.PLATFORM_USER_NAME }}
      PLATFORM_USER_PASSWORD: ${{ secrets.PLATFORM_USER_PASSWORD }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: '14'
      - name: Setup
        run: npm run setup
      - name: Tests
        run: npm run test
      - name: Build CLI
        working-directory: ./packages/cli
        run: tsc -b
      - name: Release test versions
        env:
          UI_TEMPLATE_VERSION: $(node_modules/.bin/lerna list --json | node scripts/get-next-test-version.js)
        run: |
          echo "E2E tests should target template version $UI_TEMPLATE_VERSION"
          git config --global user.email action@github.com
          git config --global user.name GitHub Action
          node_modules/.bin/lerna version $UI_TEMPLATE_VERSION -y
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }} > ~/.npmrc"
          node_modules/.bin/lerna list --json | node scripts/wait-for-published-packages.js --version $UI_TEMPLATE_VERSION
          npm run npm:publish
      - name: End-to-end Tests
        working-directory: ./packages/cli-e2e
        run: npm run test-e2e
