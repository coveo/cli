name: Build
on:
  push:
    branches:
      - master
  pull_request:

jobs:
  run-script:
    runs-on: windows-latest
    env:
      PLATFORM_USER_NAME: ${{ secrets.PLATFORM_USER_NAME }}
      PLATFORM_USER_PASSWORD: ${{ secrets.PLATFORM_USER_PASSWORD }}
      # https://github.com/oclif/plugin-update/blob/master/src/hooks/init.ts#L22 tldr: pls oclif dont try to autoupdate when im running locally or doing test. Ought to be prefixed tho.
      COVEO_DISABLE_AUTOUPDATE: true
    steps:
      - name: Set git to use LF
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf
      # - name: Setup runner
      #   # Ensure we can use as many file watcher as we want. see https://github.com/facebook/create-react-app/blob/master/docusaurus/docs/troubleshooting.md#npm-start-fail-due-to-watch-error
      #   run: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: '14'
      - name: Setup repo
        run: npm run setup
      # - name: Check linting
      #   run: npm run lint
      # - name: Tests
      #   run: npm run test
      - name: Build CLI
        working-directory: ./packages/cli
        run: tsc -b
      - name: End-to-end Tests
        working-directory: ./packages/cli-e2e
        run: |
          Start-Process "C:/Program Files/Google/Chrome/Application/chrome.exe" -ArgumentList "--no-first-run --remote-debugging-port=9222 --disable-dev-shm-usage --window-size=1080,720"
          Start-Process "npx" -ArgumentList "verdaccio --config ./docker/config/config.yaml"
          cd ../..
          npm run setup
          npm run build

          Set-Variable -Name "UI_TEMPLATE_VERSION" -Value "0.0.0"
          npm set registry http://localhost:4873
          yarn config set  registry http://localhost:4873
          yarn config set -- --mutex network
          yarn config set -- --install.silent true
          yarn config set -- --silent true

          npm run npm:bump:template -- -- $UI_TEMPLATE_VERSION

          npm run npm:publish:template

          node scripts/wait-for-published-packages.js
            
          cd packages/cli-e2e
          npm run boop
          npm run jest
      - uses: actions/upload-artifact@v2
        if: ${{ always() }}
        with:
          name: test-artifacts
          path: ./packages/cli-e2e/artifacts
