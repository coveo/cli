name: CI
on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:
jobs:
  lint:
    name: Lint
    runs-on: 'ubuntu-latest'
    steps:
      - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3
      - uses: ./.github/actions/setup-node
      - name: Lint
        run: npm run lint
  build:
    name: Unit Tests
    runs-on: 'ubuntu-latest'
    steps:
      - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3
      - uses: ./.github/actions/setup-node
      - name: Build
        run: npm run build
      - name: Tests
        run: npm test

  prerelease:
    timeout-minutes: 15
    name: Pre-release
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
    # needs: [e2e-report, lint, unit-tests]
    runs-on: ubuntu-latest
    environment: prerelease
    steps:
      - uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3
        with:
          # pulls all commits (needed for computing the next version)
          fetch-depth: 0
      - uses: ./.github/actions/setup-node
      - uses: actions/setup-node@64ed1c7eab4cce3362f8c340dee64e5eaeef8f7c # v3
        with:
          registry-url: 'https://registry.npmjs.org'
      - name: Release
        run: |
          npm run nx:graph
          npm run release:phase1
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          DEBUG: '*'
          IS_PRERELEASE: 'true'
